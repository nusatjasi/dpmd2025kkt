<script>
    const api = {
        /**
         * Helper untuk membungkus google.script.run ke dalam Promise
         */
        async run(fnName, ...args) {
            return new Promise((resolve, reject) => {
                if (typeof google === 'undefined' || !google.script || !google.script.run) {
                    console.error('google.script.run tidak tersedia. Pastikan dijalankan di lingkungan Google Apps Script.');
                    reject(new Error('GAS Environment not found'));
                    return;
                }
                google.script.run
                    .withSuccessHandler(res => resolve(res))
                    .withFailureHandler(err => reject(err))
                [fnName](...args);
            });
        },

        async getPegawai() {
            try {
                const data = await this.run('getSheetData', 'bezeting');
                return { status: 'success', data: data };
            } catch (e) {
                return { status: 'error', message: e.toString() };
            }
        },

        async getMasterData() {
            try {
                const res = await this.run('getMasterData');
                return res; // Sudah format {status, data}
            } catch (e) {
                return { status: 'error', message: e.toString() };
            }
        },

        async savePegawai(payload) {
            try {
                const res = await this.run('saveData', 'bezeting', payload);
                return { status: 'success', message: res.message, id: res.id };
            } catch (e) {
                return { status: 'error', message: e.toString() };
            }
        },

        async deletePegawai(id) {
            try {
                const res = await this.run('deleteData', 'bezeting', id);
                return { status: 'success', message: res.message };
            } catch (e) {
                return { status: 'error', message: e.toString() };
            }
        },

        async getSuratMasuk() {
            try {
                const data = await this.run('getSheetData', 'suratmasuk');
                return { status: 'success', data: data };
            } catch (e) {
                return { status: 'error', message: e.toString() };
            }
        },

        async saveSuratMasuk(payload) {
            try {
                const res = await this.run('saveData', 'suratmasuk', payload);
                return { status: 'success', message: res.message, id: res.id };
            } catch (e) {
                return { status: 'error', message: e.toString() };
            }
        },

        async deleteSuratMasuk(id) {
            try {
                const res = await this.run('deleteData', 'suratmasuk', id);
                return { status: 'success', message: res.message };
            } catch (e) {
                return { status: 'error', message: e.toString() };
            }
        },

        async uploadFile(file) {
            return new Promise((resolve, reject) => {
                if (typeof google === 'undefined' || !google.script || !google.script.run) {
                    reject(new Error('GAS Environment not found'));
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    const base64Data = e.target.result.split(',')[1];
                    const fileObj = {
                        fileName: file.name,
                        mimeType: file.type,
                        base64: base64Data
                    };
                    google.script.run
                        .withSuccessHandler(res => resolve(res))
                        .withFailureHandler(err => reject(err))
                        .uploadFile(fileObj);
                };
                reader.readAsDataURL(file);
            });
        },

        async saveMasterData(payload) {
            try {
                const res = await this.run('saveMasterData', payload);
                return res; // Already format {status, message}
            } catch (e) {
                return { status: 'error', message: e.toString() };
            }
        },

        async saveAbsensi(payload) {
            try {
                const res = await this.run('saveAbsensi', payload);
                return { status: 'success', message: res.message, id: res.id };
            } catch (e) {
                return { status: 'error', message: e.toString() };
            }
        },

        async getAbsensi(date) {
            try {
                return await this.run('getAbsensi', date);
            } catch (e) {
                return { status: 'error', message: e.toString() };
            }
        },

        async getAppSettings() {
            try {
                return await this.run('getAppSettings');
            } catch (e) {
                return { status: 'error', message: e.toString() };
            }
        },

        async saveAppSettings(payload) {
            try {
                return await this.run('saveAppSettings', payload);
            } catch (e) {
                return { status: 'error', message: e.toString() };
            }
        },

        async updateAbsensiStatus(payload) {
            try {
                return await this.run('updateAbsensiStatus', payload);
            } catch (e) {
                return { status: 'error', message: e.toString() };
            }
        },

        async getDashboardStats() {
            try {
                return await this.run('getDashboardStats');
            } catch (e) {
                return { status: 'error', message: e.toString() };
            }
        }
    };
</script>